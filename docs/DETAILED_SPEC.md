# Cypher Enigma Simulator 詳細仕様書

## 1. 目的と位置づけ

本ツールは、Cypher系パズルで使用されるエニグマ風暗号機を再現・検証するための
**教育・解析特化型の簡略エニグマシミュレーター**である。

実機エニグマの忠実再現は目的とせず、以下を最優先とする。
- 問題文仕様との一致
- 内部状態の完全可視化
- 暗号化／復号の挙動を理解できること

---

## 2. 全体アーキテクチャ

- 種別: 静的Webアプリ
- 公開: GitHub Pages
- 構成:
  - `index.html` - UI構造
  - `style.css` - スタイル定義
  - `main.js` - ロジック実装
- 外部ライブラリ: 使用しない（Vanilla JS）

---

## 3. 対応文字集合

- 対象: A-Z（大文字英字のみ）
- 非英字（空白・数字・記号）:
  - 暗号処理対象外
  - 入力 → 出力へそのまま通過

---

## 4. 構成要素仕様

### 4.1 プラグボード（Plugboard）

#### 概要
入力・出力の両端で適用される文字置換機構。

#### 入力仕様
- 形式: テキスト
- 記法例: `A-B`, `A-B, S-Z, U-Y`
- 区切り: カンマまたは空白

#### 仕様ルール
- 指定されたペアは双方向置換
- 未指定文字は恒等写像
- 不正指定（同一文字ペアなど）は無視

---

### 4.2 スクランブラー（Scrambler / Rotor）

#### 枚数
- 1〜3枚（可変）
- OFFまたは空欄のスクランブラーは無効扱い

#### プリセット配線

| 名称 | 配線 |
|------|------|
| Enigma I | EKMFLGDQVZNTOWYHXUSPAIBRCJ |
| Enigma II | AJDKSIRUXBLHWTMCQGZNPYFVOE |
| Enigma III | BDFHJLCPRTXVZNYEIWGAKMUSQO |
| Enigma IV | ESOVPZJAYQUIRHXLNFTGKDCMWB |
| Enigma V | VZBRGITYUPSDNHLXAWMJQOFECK |

#### 各スクランブラーの属性
- 内部配線: A-Zを一度ずつ含む26文字文字列
- 開始位置: A-Zの1文字

#### 回転仕様（簡略）
- 毎文字処理前に最前段が必ず回転
- 26回で次段が1回回転（カスケード）
- ノッチ・ダブルステップなし

#### 回転方向
- 暗号化: +1（左シフト）
- 復号: -1（右シフト）

---

### 4.3 リフレクター（Reflector）

#### 概要
信号を折り返すための置換機構。

#### プリセット配線

| 名称 | 配線 |
|------|------|
| Reflector B | YRUHQSLDPXNGOKMIEBFZCWVJAT |
| Reflector C | FVPJIAOYEDRZXWGCTKUQSBNMHL |

#### 入力仕様
- 26文字の置換文字列
- 自己逆写像であることを前提
- 妥当性検証は行わない

---

## 5. 暗号処理フロー（1文字）

```
1. スクランブラー回転（処理前）
2. プラグボード（入力）
3. スクランブラー順方向通過（1 → 2 → 3）
4. リフレクター
5. スクランブラー逆方向通過（3 → 2 → 1）
6. プラグボード（出力）
7. 出力確定
```

### アルゴリズム詳細

#### 順方向パス
1. 入力位置からシフト済みアルファベットの文字を取得
2. その文字を配線内で検索
3. 見つかった位置が出力位置

#### 逆方向パス
1. 入力位置から配線の文字を取得
2. その文字をシフト済みアルファベット内で検索
3. 見つかった位置が出力位置

---

## 6. 暗号化／復号モード

- UIで明示的に切替
- モード差分は回転方向のみ
- 経路構造は共通

---

## 7. 入力バリデーション

### 配線バリデーション
- 26文字であること
- A-Zのみであること
- 重複がないこと

### エラー表示
- 入力欄の赤枠ハイライト
- エラーメッセージの表示
- 処理の中断

---

## 8. データ永続化

### localStorage
- キー: `cypher-enigma-settings`
- バージョン管理付き
- 自動保存（500msデバウンス）

### URLパラメータ

| パラメータ | 説明 |
|------------|------|
| `pb` | プラグボード設定 |
| `pbe` | プラグボード有効フラグ（0=OFF） |
| `s1`, `s2`, `s3` | スクランブラー配線 |
| `p1`, `p2`, `p3` | スクランブラー位置 |
| `e1`, `e2`, `e3` | スクランブラー有効フラグ（0=OFF） |
| `rf` | リフレクター配線 |
| `rfe` | リフレクター有効フラグ（0=OFF） |
| `m` | モード（d=復号） |

URLパラメータはlocalStorageより優先される。

---

## 9. セキュリティ対策

### HTTPヘッダー（meta タグ）
- **Content-Security-Policy**: スクリプト/スタイル/画像の読み込み元を`'self'`に制限
- **X-Content-Type-Options**: `nosniff`でMIMEタイプスニッフィングを防止
- **Referrer-Policy**: `strict-origin-when-cross-origin`でリファラー漏洩を防止

### 入力サニタイズ
- 配線: A-Zのみ許可、最大26文字
- 位置: A-Zのみ許可、最大1文字
- プラグボード: A-Z、ダッシュ、カンマ、スペースのみ、最大100文字
- URLパラメータ: 読み込み時に同様のサニタイズを適用

### XSS対策
- 動的HTML生成時は`escapeHtml()`でエスケープ
- `textContent`/`value`で出力（可能な場合）
- `eval`/`Function`不使用
- 動的要素生成はハードコードされたプリセット配列から、または適切にエスケープ

### 外部リソース
- 外部ライブラリ不使用（依存関係なし）
- 外部リンクに`rel="noopener noreferrer"`を適用

### GitHub Pages固有
- `.nojekyll`ファイルでJekyll処理を無効化

---

## 10. 既知平文攻撃（解析支援）

### 10.1 概要

スクランブラーの配線はわかっているが、初期位置が不明な場合に、
暗号文と既知平文の一部から初期位置を特定する機能。

### 10.2 前提条件

攻撃者が知っている情報:
- プラグボードの有無と設定
- スクランブラーの枚数と配線
- リフレクターの有無と設定
- 暗号文
- 暗号文の一部に対応する平文（既知平文）

### 10.3 探索アルゴリズム

```
1. 有効なスクランブラー数 n を取得
2. 26^n 通りの初期位置組み合わせを生成
3. 各組み合わせについて:
   a. 設定オブジェクトを構築
   b. 暗号文を復号モードで処理
   c. 既知平文の各位置で文字が一致するか判定
   d. すべて一致したら候補として記録
4. すべての候補をリスト表示
```

### 10.4 探索空間

| スクランブラー枚数 | 組み合わせ数 |
|--------------------|--------------|
| 1枚 | 26通り |
| 2枚 | 676通り |
| 3枚 | 17,576通り |

### 10.5 主要関数

| 関数名 | 説明 |
|--------|------|
| `indexToPositions(index, count)` | 線形インデックスを位置配列に変換 |
| `buildAttackSettings(positions, baseSettings)` | テスト用設定オブジェクトを構築 |
| `testPositionCombination(settings)` | 単一組み合わせをテスト |
| `performKnownPlaintextAttack(settings)` | メイン探索関数 |
| `generatePlaintextGrid(ciphertext)` | 既知平文入力グリッドを生成 |
| `getKnownPlaintextFromGrid()` | グリッドから{position, char}ペアを収集 |

### 10.6 セキュリティ対策

- 暗号文入力はASCIIのみ許可（`beforeinput`イベントでフィルタ）
- 動的HTML生成時は`escapeHtml()`でエスケープ
- 解析タブ専用の設定を使用（メインタブの設定を直接参照しない）

---

## 11. 非対応事項

- 実機エニグマ完全再現
- リング設定
- ノッチ／ダブルステップ

---

## 12. 設計意図

本設計は「問題が解けること」「動きが理解できること」を最優先とする。
実機との差異は意図的な割り切りである。

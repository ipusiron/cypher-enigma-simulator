<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cypher Enigma Simulator</title>
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; form-action 'self'; base-uri 'self';">
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <main class="container">
    <header>
      <button type="button" id="help-btn" class="help-btn" aria-label="ヘルプ">?</button>
      <h1>Cypher Enigma Simulator</h1>
      <p class="subtitle">暗号解読ゲーム「Cypher」用の簡易エニグマシミュレーター</p>
    </header>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="modal" hidden>
      <div class="modal-overlay"></div>
      <div class="modal-content modal-confirm">
        <h2 id="confirm-title">確認</h2>
        <div class="modal-body">
          <p id="confirm-message">すべての設定をリセットしますか？</p>
        </div>
        <div class="modal-actions">
          <button type="button" id="confirm-cancel" class="btn-secondary">キャンセル</button>
          <button type="button" id="confirm-ok" class="btn-danger">リセット</button>
        </div>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal" hidden>
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <button type="button" class="modal-close" aria-label="閉じる">&times;</button>
        <h2>使い方</h2>
        <div class="modal-body">
          <h3>概要</h3>
          <p>このツールは、暗号解読ゲーム「Cypher」のエニグマ風パズルを解くための簡易シミュレーターです。</p>

          <h3>設定項目</h3>
          <dl>
            <dt>Plugboard（プラグボード）</dt>
            <dd>文字ペアを指定して入出力時に文字を交換します。例: <code>A-B, S-Z</code></dd>

            <dt>Scrambler（スクランブラー）</dt>
            <dd>26文字の配線を指定します。各文字処理前に回転します。最大3つまで設定可能。ドラッグハンドル（☰）をドラッグして順序を変更できます。並び替えても元のラベル番号（Scrambler 1, 2, 3）は維持されます。</dd>

            <dt>位置</dt>
            <dd>スクランブラーの初期位置（A-Z）を指定します。</dd>

            <dt>ノッチ</dt>
            <dd>カスケード回転（連動回転）の設定です。
              <ul>
                <li><strong>ON</strong>: 前段スクランブラーが設定位置を超えると次段が1回転</li>
                <li><strong>OFF</strong>: 26回で1回転（従来動作）</li>
              </ul>
              <strong>注意</strong>: ノッチは「次のスクランブラー」の回転タイミングを決定します。最後のスクランブラーのノッチは効果がありません。</dd>

            <dt>Reflector（リフレクター）</dt>
            <dd>信号を折り返す配線です。通常は変更不要。</dd>

            <dt>Mode（モード）</dt>
            <dd>暗号化/復号を選択します。復号時は逆方向に回転します。</dd>
          </dl>

          <h3>使用手順</h3>
          <ol>
            <li>パズルの指示に従って各設定を入力</li>
            <li>暗号文または平文を入力テキスト欄に入力</li>
            <li>「処理実行」ボタンをクリック</li>
            <li>結果と内部状態ログを確認</li>
          </ol>

          <h3>ログの見方</h3>
          <p>内部状態ログでは、各文字の処理過程を視覚的に確認できます：</p>
          <ul>
            <li><code>↓</code> : 入力位置</li>
            <li><code>↑</code> : 出力位置</li>
            <li>2行表示：上段がアルファベット、下段が配線</li>
          </ul>

          <h3>注意事項</h3>
          <ul>
            <li>A-Z以外の文字はそのまま通過します</li>
            <li>配線が空またはOFFのコンポーネントは無効になります</li>
            <li>本ツールは簡略化されており、実際のエニグマとは異なります</li>
          </ul>

          <h3>解析支援：既知平文攻撃</h3>
          <p>暗号文の一部に対応する平文がわかっている場合、スクランブラーの初期位置を特定できます。</p>
          <dl>
            <dt>前提条件</dt>
            <dd>プラグボード、スクランブラー配線、リフレクターの設定がわかっていること</dd>

            <dt>使い方</dt>
            <dd>
              <ol>
                <li>「解析支援」タブを開く</li>
                <li>プラグボード・スクランブラー・リフレクターを設定</li>
                <li>暗号文を入力（グリッドが生成される）</li>
                <li>既知の平文を対応する位置に入力（空欄は不明）</li>
                <li>「探索実行」をクリック</li>
                <li>候補から「設定に適用」で暗号化・復号タブに反映</li>
              </ol>
            </dd>

            <dt>探索空間</dt>
            <dd>スクランブラー1枚: 26通り、2枚: 676通り、3枚: 17,576通り</dd>
          </dl>
        </div>
      </div>
    </div>

    <!-- Tab Navigation -->
    <nav class="tab-nav">
      <button type="button" class="tab-btn active" data-tab="cipher">暗号化・復号</button>
      <button type="button" class="tab-btn" data-tab="analysis">解析支援</button>
    </nav>

    <!-- Tab: Cipher -->
    <div id="tab-cipher" class="tab-panel active">
      <!-- 1. Settings Section -->
      <section class="settings">
      <h2 class="section-title">Settings</h2>
      <fieldset class="toggleable" data-target="plugboard-inputs">
        <legend>
          <label class="toggle-label">
            <input type="checkbox" id="plugboard-enabled">
            <span>Plugboard</span>
          </label>
        </legend>
        <div id="plugboard-inputs" class="toggle-content">
          <label for="plugboard">文字ペア</label>
          <input type="text" id="plugboard" placeholder="A-B, S-Z, U-Y">
          <p class="helper-text">未指定の文字はそのまま通過します</p>
        </div>
      </fieldset>

      <div class="scramblers-container">
        <fieldset class="scrambler toggleable" data-scrambler-id="1">
          <legend>
            <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
              <span class="drag-handle-icon">&#x2630;</span>
            </button>
            <label class="toggle-label">
              <input type="checkbox" id="scrambler1-enabled" checked>
              <span>Scrambler 1</span>
            </label>
          </legend>
          <div class="scrambler-inputs toggle-content">
            <div class="preset-group">
              <label for="preset1">プリセット</label>
              <select id="preset1" class="preset-select" data-target="wiring1"></select>
            </div>
            <div class="wiring-group">
              <label for="wiring1">配線 (26文字)</label>
              <input type="text" id="wiring1" class="wiring" maxlength="26" placeholder="EKMFLGDQVZNTOWYHXUSPAIBRCJ">
            </div>
            <div class="position-group">
              <label for="position1">位置</label>
              <input type="text" id="position1" class="position" maxlength="1" value="A">
            </div>
            <div class="notch-group">
              <label class="notch-toggle-label">
                <input type="checkbox" id="notch1-enabled" class="notch-toggle" checked>
                <span>ノッチ</span>
              </label>
              <input type="text" id="notch1" class="notch" maxlength="1" value="Z">
            </div>
          </div>
        </fieldset>

        <fieldset class="scrambler toggleable" data-scrambler-id="2">
          <legend>
            <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
              <span class="drag-handle-icon">&#x2630;</span>
            </button>
            <label class="toggle-label">
              <input type="checkbox" id="scrambler2-enabled">
              <span>Scrambler 2</span>
            </label>
          </legend>
          <div class="scrambler-inputs toggle-content">
            <div class="preset-group">
              <label for="preset2">プリセット</label>
              <select id="preset2" class="preset-select" data-target="wiring2"></select>
            </div>
            <div class="wiring-group">
              <label for="wiring2">配線 (26文字)</label>
              <input type="text" id="wiring2" class="wiring" maxlength="26" placeholder="AJDKSIRUXBLHWTMCQGZNPYFVOE">
            </div>
            <div class="position-group">
              <label for="position2">位置</label>
              <input type="text" id="position2" class="position" maxlength="1" value="A">
            </div>
            <div class="notch-group">
              <label class="notch-toggle-label">
                <input type="checkbox" id="notch2-enabled" class="notch-toggle" checked>
                <span>ノッチ</span>
              </label>
              <input type="text" id="notch2" class="notch" maxlength="1" value="Z">
            </div>
          </div>
        </fieldset>

        <fieldset class="scrambler toggleable" data-scrambler-id="3">
          <legend>
            <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
              <span class="drag-handle-icon">&#x2630;</span>
            </button>
            <label class="toggle-label">
              <input type="checkbox" id="scrambler3-enabled">
              <span>Scrambler 3</span>
            </label>
          </legend>
          <div class="scrambler-inputs toggle-content">
            <div class="preset-group">
              <label for="preset3">プリセット</label>
              <select id="preset3" class="preset-select" data-target="wiring3"></select>
            </div>
            <div class="wiring-group">
              <label for="wiring3">配線 (26文字)</label>
              <input type="text" id="wiring3" class="wiring" maxlength="26" placeholder="BDFHJLCPRTXVZNYEIWGAKMUSQO">
            </div>
            <div class="position-group">
              <label for="position3">位置</label>
              <input type="text" id="position3" class="position" maxlength="1" value="A">
            </div>
            <div class="notch-group">
              <label class="notch-toggle-label">
                <input type="checkbox" id="notch3-enabled" class="notch-toggle" checked>
                <span>ノッチ</span>
              </label>
              <input type="text" id="notch3" class="notch" maxlength="1" value="Z">
            </div>
          </div>
        </fieldset>
      </div>
      <p class="helper-text">配線が空、またはOFFのスクランブラーは無効になります。2番目以降のスクランブラーは、前段がノッチ位置を超えると1回転します（ノッチOFF時は26回で1回転）。</p>

      <fieldset class="toggleable">
        <legend>
          <label class="toggle-label">
            <input type="checkbox" id="reflector-enabled" checked>
            <span>Reflector</span>
          </label>
        </legend>
        <div class="toggle-content reflector-inputs">
          <div class="preset-group">
            <label for="preset-reflector">プリセット</label>
            <select id="preset-reflector" class="preset-select" data-target="reflector" data-type="reflector"></select>
          </div>
          <div class="wiring-group">
            <label for="reflector">配線 (26文字)</label>
            <input type="text" id="reflector" maxlength="26" value="YRUHQSLDPXNGOKMIEBFZCWVJAT">
          </div>
          <p class="helper-text">上級者向け設定</p>
        </div>
      </fieldset>

      <fieldset class="mode-toggle">
        <legend>Mode</legend>
        <label>
          <input type="radio" name="mode" value="encrypt" checked>
          暗号化 (Encrypt)
        </label>
        <label>
          <input type="radio" name="mode" value="decrypt">
          復号 (Decrypt)
        </label>
        <p class="helper-text">復号モードでは逆方向に回転します</p>
      </fieldset>
    </section>

    <!-- Error Messages -->
    <div id="error-messages" class="error-messages" hidden></div>

    <!-- 2. Input Section -->
    <section class="input-section">
      <label for="input-text">入力テキスト</label>
      <textarea id="input-text" placeholder="暗号化/復号するテキストを入力..."></textarea>
    </section>

    <!-- 3. Process Button -->
    <div class="action-buttons">
      <button type="button" id="process-btn" class="btn-primary">処理実行</button>
      <button type="button" id="share-btn" class="btn-secondary">設定URLをコピー</button>
      <button type="button" id="reset-btn" class="btn-danger">リセット</button>
    </div>

    <!-- 4. Results Section -->
    <section class="results-section">
      <div class="output-area">
        <div class="area-header">
          <label for="output-text">出力テキスト</label>
          <button type="button" class="copy-btn" data-target="output-text">コピー</button>
        </div>
        <textarea id="output-text" readonly placeholder="結果がここに表示されます"></textarea>
      </div>

      <div class="log-area">
        <div class="area-header">
          <label for="log-output">内部状態ログ</label>
          <button type="button" class="copy-btn" data-target="log-output">コピー</button>
        </div>
        <pre id="log-output"></pre>
      </div>
    </section>
    </div>

    <!-- Tab: Analysis -->
    <div id="tab-analysis" class="tab-panel">
      <section class="analysis-section">
        <h2 class="section-title">既知平文攻撃</h2>
        <p class="section-description">
          暗号文と既知の平文から、スクランブラーの初期位置を探索します。
        </p>

        <!-- Attack Settings -->
        <div class="attack-settings">
          <!-- Plugboard -->
          <fieldset class="attack-fieldset toggleable">
            <legend>
              <label class="toggle-label">
                <input type="checkbox" id="attack-plugboard-enabled">
                <span>Plugboard</span>
              </label>
            </legend>
            <div class="toggle-content">
              <input type="text" id="attack-plugboard" placeholder="A-B, S-Z, U-Y">
            </div>
          </fieldset>

          <!-- Scramblers -->
          <div class="attack-scramblers">
            <fieldset class="attack-fieldset toggleable" data-attack-scrambler-id="1">
              <legend>
                <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
                  <span class="drag-handle-icon">&#x2630;</span>
                </button>
                <label class="toggle-label">
                  <input type="checkbox" id="attack-scrambler1-enabled" checked>
                  <span>Scrambler 1</span>
                </label>
              </legend>
              <div class="toggle-content scrambler-row">
                <select id="attack-preset1" class="attack-preset-select" data-target="attack-wiring1"></select>
                <input type="text" id="attack-wiring1" class="wiring" maxlength="26" placeholder="26文字の配線">
                <div class="attack-notch-group">
                  <label class="notch-toggle-label">
                    <input type="checkbox" id="attack-notch1-enabled" class="notch-toggle" checked>
                    <span>ノッチ</span>
                  </label>
                  <input type="text" id="attack-notch1" class="notch" maxlength="1" value="Z">
                </div>
              </div>
            </fieldset>

            <fieldset class="attack-fieldset toggleable" data-attack-scrambler-id="2">
              <legend>
                <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
                  <span class="drag-handle-icon">&#x2630;</span>
                </button>
                <label class="toggle-label">
                  <input type="checkbox" id="attack-scrambler2-enabled">
                  <span>Scrambler 2</span>
                </label>
              </legend>
              <div class="toggle-content scrambler-row">
                <select id="attack-preset2" class="attack-preset-select" data-target="attack-wiring2"></select>
                <input type="text" id="attack-wiring2" class="wiring" maxlength="26" placeholder="26文字の配線">
                <div class="attack-notch-group">
                  <label class="notch-toggle-label">
                    <input type="checkbox" id="attack-notch2-enabled" class="notch-toggle" checked>
                    <span>ノッチ</span>
                  </label>
                  <input type="text" id="attack-notch2" class="notch" maxlength="1" value="Z">
                </div>
              </div>
            </fieldset>

            <fieldset class="attack-fieldset toggleable" data-attack-scrambler-id="3">
              <legend>
                <button type="button" class="drag-handle" aria-label="ドラッグして並び替え">
                  <span class="drag-handle-icon">&#x2630;</span>
                </button>
                <label class="toggle-label">
                  <input type="checkbox" id="attack-scrambler3-enabled">
                  <span>Scrambler 3</span>
                </label>
              </legend>
              <div class="toggle-content scrambler-row">
                <select id="attack-preset3" class="attack-preset-select" data-target="attack-wiring3"></select>
                <input type="text" id="attack-wiring3" class="wiring" maxlength="26" placeholder="26文字の配線">
                <div class="attack-notch-group">
                  <label class="notch-toggle-label">
                    <input type="checkbox" id="attack-notch3-enabled" class="notch-toggle" checked>
                    <span>ノッチ</span>
                  </label>
                  <input type="text" id="attack-notch3" class="notch" maxlength="1" value="Z">
                </div>
              </div>
            </fieldset>
          </div>

          <!-- Reflector -->
          <fieldset class="attack-fieldset toggleable">
            <legend>
              <label class="toggle-label">
                <input type="checkbox" id="attack-reflector-enabled" checked>
                <span>Reflector</span>
              </label>
            </legend>
            <div class="toggle-content scrambler-row">
              <select id="attack-preset-reflector" class="attack-preset-select" data-target="attack-reflector" data-type="reflector"></select>
              <input type="text" id="attack-reflector" maxlength="26" value="YRUHQSLDPXNGOKMIEBFZCWVJAT">
            </div>
          </fieldset>
        </div>

        <!-- Attack Inputs -->
        <div class="attack-inputs">
          <div class="input-group">
            <label for="attack-ciphertext">暗号文</label>
            <textarea id="attack-ciphertext" placeholder="探索対象の暗号文を入力..."></textarea>
          </div>

          <div class="input-group">
            <label>既知平文</label>
            <p class="helper-text">暗号文の各文字に対応する平文がわかっている場合、下の入力欄に入力してください。空欄は不明を意味します。</p>
            <div id="plaintext-grid" class="plaintext-grid">
              <p class="grid-placeholder">暗号文を入力すると、ここに入力欄が表示されます</p>
            </div>
          </div>
        </div>

        <!-- Search Info -->
        <div class="search-info" id="attack-search-info">
          <span class="search-space">探索空間: <strong id="attack-combinations">-</strong></span>
        </div>

        <!-- Action -->
        <div class="attack-actions">
          <button type="button" id="attack-run-btn" class="btn-primary">探索実行</button>
        </div>

        <!-- Error Messages -->
        <div id="attack-error-messages" class="error-messages" hidden></div>

        <!-- Progress Indicator -->
        <div id="attack-progress" class="progress-indicator" hidden>
          <span class="spinner"></span>
          <span>探索中...</span>
        </div>

        <!-- Results -->
        <div class="attack-results-section">
          <div class="results-header">
            <h3>探索結果</h3>
            <span id="attack-result-count">-</span>
          </div>
          <div id="attack-results" class="attack-results">
            <p class="placeholder-message">探索を実行すると結果がここに表示されます</p>
          </div>
        </div>
      </section>
    </div>

    <!-- Apply Confirm Modal -->
    <div id="apply-confirm-modal" class="modal" hidden>
      <div class="modal-overlay"></div>
      <div class="modal-content modal-confirm">
        <h2>設定を適用</h2>
        <div class="modal-body">
          <p id="apply-confirm-message">スクランブラーの初期位置を設定しますか？</p>
        </div>
        <div class="modal-actions">
          <button type="button" id="apply-confirm-cancel" class="btn-secondary">キャンセル</button>
          <button type="button" id="apply-confirm-ok" class="btn-primary">適用</button>
        </div>
      </div>
    </div>

    <footer class="footer">
      🔗 GitHubリポジトリはこちら（ <a href="https://github.com/ipusiron/cypher-enigma-simulator" target="_blank" rel="noopener noreferrer">ipusiron/cypher-enigma-simulator</a> ）
    </footer>
  </main>

  <script src="main.js"></script>
</body>
</html>
